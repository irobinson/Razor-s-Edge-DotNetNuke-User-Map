/*
 *  GMAP3 Plugin for JQuery 
 *  Version   : 1.2
 *  Date      : December 3, 2010
 *  Licence   : GPL v3 : http://www.gnu.org/licenses/gpl.html  
 *  Author    : DEMONTE Jean-Baptiste
 *  Contact   : jbdemonte@gmail.com
 *  Web site  : http://night-coder.com      
 */
$.gmap3={_ids:{},_running:{},_stack:{_todo:{},add:function(b,a){if(!this._todo[b]){this._todo[b]=[]}this._todo[b].push(a)},get:function(b){if(this._todo[b]){for(var a in this._todo[b]){if(this._todo[b][a]){return this._todo[b][a]}}}return false},ack:function(b){if(this._todo[b]){for(var a in this._todo[b]){if(this._todo[b][a]){delete this._todo[b][a];break}}}if(this.empty(b)){delete this._todo[b]}},empty:function(b){if(!this._todo[b]){return true}for(var a in this._todo[b]){if(this._todo[b][a]){return false}}return true}},_default:{init:{mapTypeId:google.maps.MapTypeId.ROADMAP,center:{lat:46.593623,lng:0.342922},zoom:10}},_geocoder:null,_getGeocoder:function(){if(!this._geocoder){this._geocoder=new google.maps.Geocoder()}return this._geocoder},_directionsService:null,_getDirectionsService:function(){if(!this._directionsService){this._directionsService=new google.maps.DirectionsService()}return this._directionsService},_exist:function(a){return this._ids[a]&&this._ids[a].map?true:false},_plan:function(c,a){for(var b in a){this._stack.add(c,a[b])}this._run(c)},_run:function(b){if(this._running[b]){return}var a=this._stack.get(b);if(!a){return}this._running[b]=true;this._proceed(b,a)},_end:function(a){delete this._running[a];this._stack.ack(a);this._run(a)},_autoInit:function(b){var c=[":init",":geoLatLng",":getLatLng",":getRoute",":addStyledMap",":destroy"];for(var a in c){if(c[a]==b){return false}}return true},_proceed:function(d,c){var b=(c&&c.action)||":init";var a=b.substr(0,1);if(a=="_"){return}if(!this._exist(d)&&this._autoInit(b)){this.init(d,$.extend({},this._default.init,c.args&&c.args["map"]?c.args["map"]:{}),true)}if(a==":"){b=b.substr(1);if(typeof(this[b])=="function"){c.out=this[b](d,$.extend({},this._default[b],c.args&&c.args?c.args:[]))}}else{if(c.target){if(typeof(c.target[b])=="function"){c.out=c.target[b].apply(c.target,c&&c.args?c.args:[])}}else{if(typeof(this._ids[d].map[b])=="function"){c.out=this._ids[d].map[b].apply(this._ids[d].map,c&&c.args?c.args:[])}}this._end(d)}},_call:function(){if(arguments.length<2){return}if(!this._exist(arguments[0])){return}if(typeof(this._ids[arguments[0]].map[arguments[1]])!="function"){return}var a=[];for(var b=2;b<arguments.length;b++){a.push(arguments[b])}return this._ids[arguments[0]].map[arguments[1]].apply(this._ids[arguments[0]].map,a)},destroy:function(b,a){if((b=="")||(!this._exist(b))){return false}$("#"+b).html("");if(this._ids[b].dr){delete this._ids[b].dr}delete this._ids[b].map;delete this._ids[b];delete this._running[b]},init:function(e,d,a){if((e=="")||(this._exist(e))){return false}if(d&&(typeof(d.center)=="boolean")&&d.center){return false}var c=$.extend({},this._default.init,d);if(!c.center){c.center={lat:this._default.init.center["lat"],lng:this._default.init.center["lng"]}}if(typeof(c.center["lat"])!="function"){c.center=new google.maps.LatLng(d.center["lat"],d.center["lng"])}if(!this._ids[e]){this._ids[e]={}}this._ids[e].map=new google.maps.Map(document.getElementById(e),c);if(this._ids[e].styles){for(var b in this._ids[e].styles){this._ids[e].map.mapTypes.set(b,this._ids[e].styles[b])}}if(d.events){this._attachEvents(e,this._ids[e].map,d.events)}if(!a){this._end(e)}return true},_subcall:function(c,b,a){if(!b.map){return}if(!this._exist(c)){this.init(c,$.extend({},b.map,{center:a}))}else{if(b.map["center"]){this._call(c,"setCenter",a)}if(typeof(b.map["zoom"])!="undefined"){this._call(c,"setZoom",b.map["zoom"])}if(typeof(b.map["mapTypeId"])!="undefined"){this._call(c,"setMapTypeId",b.map["mapTypeId"])}}},_resolveLatLng:function(d,a,c){if(a.address){var b=function(f,e){if(e==google.maps.GeocoderStatus.OK){$.gmap3[c](d,a,f[0].geometry.location)}};this._getGeocoder().geocode({address:a.address},b)}else{if(a.latLng){this[c](d,a,a.latLng)}else{if((typeof(a.lat)!="undefined")&&(typeof(a.lng)!="undefined")){this[c](d,a,new google.maps.LatLng(a.lat,a.lng))}else{this[c](d,a,false)}}}},_attachEvent:function(d,c,a,b){google.maps.event.addListener(c,a,function(e){b(d,c,e)})},_attachEvents:function(d,c,a){for(var b in a){if(typeof(a[b])=="function"){this._attachEvent(d,c,b,a[b])}}},_addMarker:function(f,e,d){if(!d){return}var a=false;this._subcall(f,e,d);var c=e.marker&&e.marker["options"]?e.marker["options"]:{};c.position=d;c.map=this._ids[f].map;var a=new google.maps.Marker(c);if(e.marker){if(e.marker["events"]){this._attachEvents(f,a,e.marker["events"])}if(e.marker["methods"]){for(var b in e.marker["methods"]){if(typeof(e.marker["methods"][b])=="function"){e.marker["methods"][b].apply(a,e.marker["methods"][b]?e.marker["methods"][b]:[])}}}}e.out=a;if(typeof(e.callback)=="function"){e.callback(f,a)}this._end(f)},addMarker:function(b,a){this._resolveLatLng(b,a,"_addMarker")},_addInfoWindow:function(b,e,d){this._subcall(b,e,d);var a=e.infowindow&&e.infowindow["options"]?e.infowindow["options"]:{};if(d){a.position=d}var g=new google.maps.InfoWindow(a);if(e.infowindow&&e.infowindow["events"]){this._attachEvents(b,g,e.infowindow["events"])}if(e.infowindow&&e.infowindow["apply"]){for(var f in e.infowindow["apply"]){var l=e.infowindow["apply"][f];if(!l.action){continue}if(l.action=="open"){var j=[this._ids[b].map];var h=0;for(var f in l.args){j[++h]=l.args[f]}}else{var j=l.args}g[l.action].apply(g,j)}}e.out=g;if(typeof(e.callback)=="function"){e.callback(b,g)}this._end(b)},addInfoWindow:function(b,a){this._resolveLatLng(b,a,"_addInfoWindow")},_latLng:function(a){if((typeof(a.lat)!="undefined")&&(typeof(a.lat)!="function")){return new google.maps.LatLng(a.lat,a.lng)}else{return a}},getRoute:function(c,a){if(typeof(a.callback)=="function"){a.options["origin"]=this._latLng(a.options["origin"]);a.options["destination"]=this._latLng(a.options["destination"]);var b=function(e,d){a.out=d==google.maps.DirectionsStatus.OK?e:false;a.callback(c,a.out)};this._getDirectionsService().route(a.options,b)}this._end(c)},addDirectionsRenderer:function(e,d,a){if(this._ids[e].dr){this.removeDirectionsRenderer(e)}var c=d.options?d.options:{};d.options["map"]=this._ids[e].map;var b=d.options["panelId"];if(b){delete d.options["panelId"]}this._ids[e].dr=new google.maps.DirectionsRenderer(d.options);if(b){this._ids[e].dr.setPanel(document.getElementById(b))}if(d.events){this._attachEvents(e,this._ids[e].dr,d.events)}d.out=this._ids[e].dr;if(!a){this._end(e)}},setDirectionsPanel:function(b,a){if(this._ids[b].dr&&a&&a.id){this._ids[b].dr.setPanel(document.getElementById(a.id))}this._end(b)},setDirections:function(b,a){if(!a.directions){return}if(!this._ids[b].dr){this.addDirectionsRenderer(b,{options:a},true)}else{this._ids[b].dr.setDirections(a.directions)}this._end(b)},removeDirectionsRenderer:function(a){if(this._ids[a]&&this._ids[a].dr){delete this._ids[a].dr}this._end(a)},addPolyline:function(f,e){var c=e.options?e.options:{};if(e.path){c.path=[];var b=0;for(var a in e.path){c.path[b++]=new google.maps.LatLng(e.path[a][0],e.path[a][1])}}var d=new google.maps.Polyline(c);if(e.events){this._attachEvents(f,d,e.events)}d.setMap(this._ids[f].map);this._end(f)},addPolygon:function(f,e){var c=e.options?e.options:{};if(e.paths){c.paths=[];var b=0;for(var a in e.paths){c.paths[b++]=new google.maps.LatLng(e.paths[a][0],e.paths[a][1])}}var d=new google.maps.Polygon(c);if(e.events){this._attachEvents(f,d,e.events)}d.setMap(this._ids[f].map);this._end(f)},setStreetView:function(d,c){var b=c.options?c.options:{};var a=new google.maps.StreetViewPanorama(document.getElementById(c.id),b);this._ids[d].map.setStreetView(a);this._end(d)},setKmlLayer:function(d,c){var b=c.options?c.options:{};b.map=this._ids[d].map;var a=new google.maps.KmlLayer(c.url,b);if(c.events){this._attachEvents(d,a,c.events)}this._end(d)},setTrafficLayer:function(c,b){var a=new google.maps.TrafficLayer();a.setMap(this._ids[c].map);this._end(c)},setBicyclingLayer:function(c,b){var a=new google.maps.BicyclingLayer();a.setMap(this._ids[c].map);this._end(c)},setGroundOverlay:function(e,d){if(typeof(d.bounds["getCenter"])=="function"){var c=d.bounds}else{for(var b=0;b<2;b++){if(typeof(d.bounds[b]["lat"])!="function"){d.bounds[b]=new google.maps.LatLng(d.bounds[b]["lat"],d.bounds[b]["lng"])}}var c=new google.maps.LatLngBounds(d.bounds[0],d.bounds[1])}var a=new google.maps.GroundOverlay(d.url,c);if(d.events){this._attachEvents(e,a,d.events)}a.setMap(this._ids[e].map);this._end(e)},getLatLng:function(c,a){if(typeof(a.callback)=="function"){if(a.address){var b=function(e,d){a.out=d==google.maps.GeocoderStatus.OK?e:false;a.callback(c,a.out)};this._getGeocoder().geocode({address:a.address},b)}else{a.out=false;a.callback(c,a.out)}}this._end(c)},geoLatLng:function(c,b){if(typeof(b.callback)=="function"){if(navigator.geolocation){browserSupportFlag=true;navigator.geolocation.getCurrentPosition(function(d){b.callback(c,new google.maps.LatLng(d.coords.latitude,d.coords.longitude))},function(){b.callback(c,false)})}else{if(google.gears){browserSupportFlag=true;var a=google.gears.factory.create("beta.geolocation");a.getCurrentPosition(function(d){b.callback(c,new google.maps.LatLng(d.latitude,d.longitude))},function(){b.callback(c,false)})}else{b.callback(c,false)}}}this._end(c)},addStyledMap:function(c,b,a){if(b.style&&b.id){b.out=new google.maps.StyledMapType(b.style,b.options);if(!this._ids[c]){this._ids[c]={}}if(!this._ids[c].styles){this._ids[c].styles={}}this._ids[c].styles[b.id]=b.out;if(this._ids[c].map){this._ids[c].map.mapTypes.set(b.id,b.out)}}if(!a){this._end(c)}},setStyledMap:function(b,a){if(a.id){this.addStyledMap(b,a,true);if(this._ids[b].styles[a.id]){this._ids[b].map.setMapTypeId(a.id)}}this._end(b)},setDefault:function(b){for(var a in b){this._default[a]=$.extend({},this._default[a],b[a])}}};jQuery.fn.extend({gmap3:function(){var c=$(this);if(c.length>0){var d=c.attr("id");var a=[];for(var b=0;b<arguments.length;b++){a.push(arguments[b]||{})}if(!a.length){a.push({})}$.gmap3._plan(d,a)}return $(this)}});